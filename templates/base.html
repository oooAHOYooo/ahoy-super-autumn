<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Primary Meta Tags -->
        <title>{% block title %}AHOY Indie Media - New Haven Arts & Culture
            Platform{% endblock %}</title>
        <meta name="title"
            content="{% block meta_title %}AHOY Indie Media - New Haven Arts & Culture Platform{% endblock %}">
        <meta name="description"
            content="{% block meta_description %}Discover upcoming poetry readings, music shows, and cabaret performances in New Haven. AHOY connects local artists, musicians, and performers with audiences.{% endblock %}">
        <meta name="keywords"
            content="{% block meta_keywords %}New Haven events, poetry readings, music shows, cabaret performances, local artists, indie media, Connecticut arts, live performances, cultural events{% endblock %}">
        <meta name="author" content="AHOY Indie Media">
        <meta name="robots" content="index, follow">
        <meta name="language" content="English">
        <meta name="revisit-after" content="7 days">

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="{{ request.url }}">
        <meta property="og:title"
            content="{% block og_title %}AHOY Indie Media - New Haven Arts & Culture Platform{% endblock %}">
        <meta property="og:description"
            content="{% block og_description %}Discover upcoming poetry readings, music shows, and cabaret performances in New Haven. AHOY connects local artists, musicians, and performers with audiences.{% endblock %}">
        <meta property="og:image"
            content="{% block og_image %}{{ url_for('static', filename='uploads/devPhoto_poets3.jpg', _external=True) }}{% endblock %}">
        <meta property="og:site_name" content="AHOY Indie Media">
        <meta property="og:locale" content="en_US">

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="{{ request.url }}">
        <meta property="twitter:title"
            content="{% block twitter_title %}AHOY Indie Media - New Haven Arts & Culture Platform{% endblock %}">
        <meta property="twitter:description"
            content="{% block twitter_description %}Discover upcoming poetry readings, music shows, and cabaret performances in New Haven. AHOY connects local artists, musicians, and performers with audiences.{% endblock %}">
        <meta property="twitter:image"
            content="{% block twitter_image %}{{ url_for('static', filename='uploads/devPhoto_poets3.jpg', _external=True) }}{% endblock %}">

        <!-- Additional SEO Meta Tags -->
        <meta name="theme-color" content="#f4c430">
        <meta name="msapplication-TileColor" content="#f4c430">
        <meta name="application-name" content="AHOY Indie Media">

        <!-- Canonical URL -->
        <link rel="canonical" href="{{ request.url }}">

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon"
            href="{{ url_for('static', filename='favicon.ico') }}">

        <!-- Stylesheet -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}">

        <!-- Structured Data -->
        {% block structured_data %}{% endblock %}
    </head>
    <body>
        <nav class="navbar">
            <div class="nav-container">
                <a href="/" class="nav-logo">AHOY</a>
                <div class="nav-links">
                    <a href="/">Home</a>
                    <a href="/about">About</a>
                    <a href="/events">Events</a>
                    <a href="/download">Download</a>
                </div>
            </div>
        </nav>

        <main id="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">AHOY</div>
                    <div class="footer-subtitle">INDIE MEDIA</div>
                </div>
                <div class="footer-info">
                    <div class="contact-info">
                        <h4>Contact</h4>
                        <p>New Haven, CT</p>
                        <p>hello@ahoyindie.com</p>
                    </div>
                    <div class="newsletter-signup">
                        <h4>Stay Updated</h4>
                        <form class="newsletter-form" action="/newsletter"
                            method="POST">
                            <input type="email" name="email"
                                placeholder="Your email address" required>
                            <button type="submit"
                                class="btn btn-small">Subscribe</button>
                        </form>
                    </div>
                    <div class="policy-links">
                        <h4>Legal</h4>
                        <div class="policy-links-list">
                            <a href="/service-policy"
                                class="policy-link">Service Policy</a>
                            <a href="/privacy-policy"
                                class="policy-link">Privacy Policy</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Lightbox -->
        <div class="lightbox" id="lightbox">
            <div class="lightbox-content">
                <button class="lightbox-close"
                    id="lightbox-close">&times;</button>
                <img class="lightbox-image" id="lightbox-image" src alt>
            </div>
        </div>

        <!-- RSVP Modal -->
        <div class="rsvp-modal" id="rsvp-modal">
            <div class="rsvp-modal-content">
                <div class="rsvp-modal-header">
                    <h3 id="rsvp-event-title">RSVP for Event</h3>
                    <button class="rsvp-modal-close"
                        id="rsvp-modal-close">&times;</button>
                </div>
                <form id="rsvp-form">
                    <div class="form-group">
                        <label for="rsvp-name">Name *</label>
                        <input type="text" id="rsvp-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="rsvp-email">Email *</label>
                        <input type="email" id="rsvp-email" name="email"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="rsvp-guests">Number of Guests</label>
                        <input type="number" id="rsvp-guests" name="guests"
                            value="1" min="1" max="10">
                    </div>
                    <div class="form-actions">
                        <button type="submit"
                            class="btn btn-primary">RSVP</button>
                        <button type="button" class="btn btn-secondary"
                            id="rsvp-cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Congratulations Overlay -->
        <div class="congratulations-overlay" id="congratulations-overlay">
            <div class="congratulations-content">
                <div class="congratulations-details"
                    id="congratulations-details"></div>
            </div>
        </div>

        <script>
        // Event filtering functionality
        document.addEventListener('DOMContentLoaded', function() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            const eventItems = document.querySelectorAll('.event-item');
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    
                    eventItems.forEach(item => {
                        if (filter === 'all' || item.getAttribute('data-type') === filter) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });

            // Event card expansion functionality
            const eventPreviews = document.querySelectorAll('.event-preview');
            
            eventPreviews.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't expand if clicking on image (that opens lightbox)
                    if (e.target.classList.contains('event-image')) {
                        return;
                    }
                    
                    // Toggle expanded state
                    const isExpanded = this.classList.contains('expanded');
                    
                    // Remove expanded state from all cards
                    eventPreviews.forEach(c => c.classList.remove('expanded'));
                    
                    if (!isExpanded) {
                        // Expand this card
                        this.classList.add('expanded');
                    }
                });
            });

            // Lightbox functionality
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxClose = document.getElementById('lightbox-close');
            const lightboxImages = document.querySelectorAll('[data-lightbox]');
            
            lightboxImages.forEach(img => {
                img.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent card expansion
                    lightboxImage.src = this.getAttribute('data-lightbox');
                    lightboxImage.alt = this.alt;
                    lightbox.classList.add('active');
                });
            });
            
            lightboxClose.addEventListener('click', function() {
                lightbox.classList.remove('active');
            });
            
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    lightbox.classList.remove('active');
                }
            });
            
            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    lightbox.classList.remove('active');
                    eventPreviews.forEach(c => c.classList.remove('expanded'));
                    document.getElementById('rsvp-modal').classList.remove('active');
                }
            });

            // RSVP functionality
            const rsvpModal = document.getElementById('rsvp-modal');
            const rsvpForm = document.getElementById('rsvp-form');
            const rsvpModalClose = document.getElementById('rsvp-modal-close');
            const rsvpCancel = document.getElementById('rsvp-cancel');
            const rsvpBtns = document.querySelectorAll('.rsvp-btn');
            let currentEventId = null;

            rsvpBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent card expansion
                    currentEventId = this.getAttribute('data-event-id');
                    const eventTitle = this.closest('.event-preview, .event-item').querySelector('h3').textContent;
                    document.getElementById('rsvp-event-title').textContent = `RSVP for ${eventTitle}`;
                    rsvpModal.classList.add('active');
                });
            });

            rsvpModalClose.addEventListener('click', function() {
                rsvpModal.classList.remove('active');
            });

            rsvpCancel.addEventListener('click', function() {
                rsvpModal.classList.remove('active');
            });

            rsvpModal.addEventListener('click', function(e) {
                if (e.target === rsvpModal) {
                    rsvpModal.classList.remove('active');
                }
            });

            rsvpForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!currentEventId) return;

                const formData = new FormData(this);
                formData.append('event_id', currentEventId);

                fetch(`/rsvp/${currentEventId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        rsvpModal.classList.remove('active');
                        
                        // Show congratulations overlay with parallax effects
                        const congratulationsOverlay = document.getElementById('congratulations-overlay');
                        const congratulationsDetails = document.getElementById('congratulations-details');
                        const eventTitle = document.querySelector(`[data-event-id="${currentEventId}"]`).closest('.event-preview, .event-item').querySelector('h3').textContent;
                        
                        congratulationsDetails.innerHTML = `
                            <div class="congratulations-icon">🎉</div>
                            <div class="congratulations-title">CONGRATULATIONS!</div>
                            <div class="congratulations-message">You're in for</div>
                            <div class="congratulations-event">${eventTitle}</div>
                            <div class="congratulations-count">${data.rsvp_count} RSVP${data.rsvp_count !== 1 ? 's' : ''} total</div>
                        `;
                        
                        congratulationsOverlay.classList.add('active');
                        
                        // Show toast notification
                        showToast(`Successfully RSVP'd for ${eventTitle}!`, 'success');
                        
                        // Auto-hide after 1.5 seconds (blink of an eye)
                        setTimeout(() => {
                            congratulationsOverlay.classList.remove('active');
                        }, 1500);
                        
                        // Update RSVP count display - only show when there are RSVPs
                        const rsvpBtn = document.querySelector(`[data-event-id="${currentEventId}"]`);
                        if (rsvpBtn) {
                            const rsvpSection = rsvpBtn.parentElement;
                        }
                        
                        // Reset form
                        this.reset();
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
            });
        });
        </script>
    </body>
</html>
