<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Primary Meta Tags -->
        <title>{% block title %}AHOY Indie Media - New Haven Arts & Culture
            Platform{% endblock %}</title>
        <meta name="title"
            content="{% block meta_title %}AHOY Indie Media - New Haven Arts & Culture Platform{% endblock %}">
        <meta name="description"
            content="{% block meta_description %}Discover upcoming poetry readings, music shows, and cabaret performances in New Haven. AHOY connects local artists, musicians, and performers with audiences.{% endblock %}">
        <meta name="keywords"
            content="{% block meta_keywords %}New Haven events, poetry readings, music shows, cabaret performances, local artists, indie media, Connecticut arts, live performances, cultural events{% endblock %}">
        <meta name="author" content="AHOY Indie Media">
        <meta name="robots" content="index, follow">
        <meta name="language" content="English">
        <meta name="revisit-after" content="7 days">

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="{{ request.url }}">
        <meta property="og:title"
            content="{% block og_title %}AHOY Indie Media - New Haven Arts & Culture Platform{% endblock %}">
        <meta property="og:description"
            content="{% block og_description %}Discover upcoming poetry readings, music shows, and cabaret performances in New Haven. AHOY connects local artists, musicians, and performers with audiences.{% endblock %}">
        <meta property="og:image"
            content="{% block og_image %}{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}{% endblock %}">
        <meta property="og:site_name" content="AHOY Indie Media">
        <meta property="og:locale" content="en_US">

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="{{ request.url }}">
        <meta property="twitter:title"
            content="{% block twitter_title %}AHOY Indie Media - New Haven Arts & Culture Platform{% endblock %}">
        <meta property="twitter:description"
            content="{% block twitter_description %}Discover upcoming poetry readings, music shows, and cabaret performances in New Haven. AHOY connects local artists, musicians, and performers with audiences.{% endblock %}">
        <meta property="twitter:image"
            content="{% block twitter_image %}{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}{% endblock %}">

        <!-- Additional SEO Meta Tags -->
        <meta name="theme-color" content="#f4c430">
        <meta name="msapplication-TileColor" content="#f4c430">
        <meta name="application-name" content="AHOY Indie Media">

        <!-- Canonical URL -->
        <link rel="canonical" href="{{ request.url }}">

        <!-- Favicon - Multiple formats for optimal browser support -->
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="144x144" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="120x120" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="114x114" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="72x72" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="60x60" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="57x57" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="shortcut icon" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        <link rel="icon" href="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png') }}">
        
        <!-- Microsoft Tiles -->
        <meta name="msapplication-TileImage" content="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}">
        <meta name="msapplication-square70x70logo" content="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}">
        <meta name="msapplication-square150x150logo" content="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}">
        <meta name="msapplication-wide310x150logo" content="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}">
        <meta name="msapplication-square310x310logo" content="{{ url_for('static', filename='logos/ahoy-fall2025-favicon.png', _external=True) }}">
        
        <!-- Android Chrome -->
        <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

        <!-- Stylesheet -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css', v='20251007') }}">

        <!-- Security Headers -->
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://storage.googleapis.com; connect-src 'self'; media-src 'self' data: blob: https://storage.googleapis.com;">
        <meta http-equiv="X-Content-Type-Options" content="nosniff">
        <meta http-equiv="X-XSS-Protection" content="1; mode=block">

        <!-- Structured Data -->
        {% block structured_data %}{% endblock %}

        {% block extra_css %}{% endblock %}
    </head>
    <body>
        <nav class="navbar">
            <div class="nav-container">
                <a href="/" class="nav-logo">
                    <img
                        src="{{ url_for('static', filename='logos/ahoy indie media - main logo.png') }}"
                        alt="AHOY Indie Media"
                        class="logo-image"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="logo-fallback"
                        style="display: none;">AHOY</span>
                </a>
                <div class="nav-links">
                    <a href="/">Home</a>
                    <a href="/about">About</a>
                    <a href="/events">Events</a>
                    <a href="/download">Download</a>
                </div>
            </div>
        </nav>

        <main id="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-brand">
                    <img
                        src="{{ url_for('static', filename='logos/ahoy indie media - main logo.png') }}"
                        alt="AHOY Indie Media"
                        class="footer-logo-image"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="footer-logo-fallback" style="display: none;">
                        <div class="footer-logo">AHOY</div>
                        <div class="footer-subtitle">INDIE MEDIA</div>
                    </div>
                </div>
                <div class="footer-info">
                    <div class="contact-info">
                        <h4>Contact</h4>
                        <p>New Haven, CT</p>
                        <p>alex@ahoy.ooo</p>
                    </div>
                    <div class="newsletter-signup">
                        <h4>Stay Updated</h4>
                        <form class="newsletter-form" action="/newsletter"
                            method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="email" name="email"
                                placeholder="Your email address" required>
                            <button type="submit"
                                class="btn btn-small">Subscribe</button>
                        </form>
                    </div>
                    <div class="artist-submission">
                        <h4>Want to Perform?</h4>
                        <p>Submit your performance proposal!</p>
                        <a href="/artist-submission"
                            class="btn btn-small">Submit Proposal</a>
                    </div>
                    <div class="policy-links">
                        <h4>Legal</h4>
                        <div class="policy-links-list">
                            <a href="/service-policy"
                                class="policy-link">Service Policy</a>
                            <a href="/privacy-policy"
                                class="policy-link">Privacy Policy</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Lightbox -->
        <div class="lightbox" id="lightbox">
            <div class="lightbox-content">
                <button class="lightbox-close"
                    id="lightbox-close">&times;</button>
                <img class="lightbox-image" id="lightbox-image" src alt>
                <div class="lightbox-nav">
                    <button id="lightbox-prev" class="lightbox-btn">â€¹</button>
                    <button id="lightbox-next" class="lightbox-btn">â€º</button>
                </div>
                <div class="lightbox-counter">
                    <span id="lightbox-current">1</span> / <span
                        id="lightbox-total">1</span>
                </div>
            </div>
        </div>

        <!-- RSVP Modal -->
        <div class="rsvp-modal" id="rsvp-modal">
            <div class="rsvp-modal-content">
                <div class="rsvp-modal-header">
                    <h3 id="rsvp-event-title">RSVP for Event</h3>
                    <button class="rsvp-modal-close"
                        id="rsvp-modal-close">&times;</button>
                </div>
                <form id="rsvp-form">
                    <div class="form-group">
                        <label for="rsvp-name">Name *</label>
                        <input type="text" id="rsvp-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="rsvp-email">Email *</label>
                        <input type="email" id="rsvp-email" name="email"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="rsvp-guests">Number of Guests</label>
                        <input type="number" id="rsvp-guests" name="guests"
                            value="1" min="1" max="10">
                    </div>
                    <div class="form-actions">
                        <button type="submit"
                            class="btn btn-primary">RSVP</button>
                        <button type="button" class="btn btn-secondary"
                            id="rsvp-cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Congratulations Overlay -->
        <div class="congratulations-overlay" id="congratulations-overlay">
            <div class="congratulations-content">
                <div class="congratulations-details"
                    id="congratulations-details"></div>
            </div>
        </div>

        <script>
        // Event filtering functionality
        document.addEventListener('DOMContentLoaded', function() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            const eventItems = document.querySelectorAll('.event-item');
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    
                    eventItems.forEach(item => {
                        if (filter === 'all' || item.getAttribute('data-type') === filter) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });

            // Event card expansion functionality
            const eventPreviews = document.querySelectorAll('.event-preview');
            
            eventPreviews.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't expand if clicking on image (that opens lightbox)
                    if (e.target.classList.contains('event-image')) {
                        return;
                    }
                    
                    // Toggle expanded state
                    const isExpanded = this.classList.contains('expanded');
                    
                    // Remove expanded state from all cards
                    eventPreviews.forEach(c => c.classList.remove('expanded'));
                    
                    if (!isExpanded) {
                        // Expand this card
                        this.classList.add('expanded');
                    }
                });
            });

            // Lightbox functionality with navigation
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxClose = document.getElementById('lightbox-close');
            const lightboxPrev = document.getElementById('lightbox-prev');
            const lightboxNext = document.getElementById('lightbox-next');
            const lightboxCurrent = document.getElementById('lightbox-current');
            const lightboxTotal = document.getElementById('lightbox-total');
            const lightboxImages = document.querySelectorAll('[data-lightbox]');
            
            let currentImageIndex = 0;
            let currentImages = [];
            
            // Initialize lightbox with all images
            function initLightbox() {
                currentImages = Array.from(lightboxImages);
                lightboxTotal.textContent = currentImages.length;
            }
            
            // Open lightbox at specific index
            function openLightbox(index) {
                if (currentImages.length === 0) return;
                
                currentImageIndex = index;
                updateLightboxImage();
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Update lightbox image
            function updateLightboxImage() {
                if (currentImages.length === 0) return;
                
                const currentImage = currentImages[currentImageIndex];
                lightboxImage.src = currentImage.getAttribute('data-lightbox');
                lightboxImage.alt = currentImage.alt;
                lightboxCurrent.textContent = currentImageIndex + 1;
                
                // Show/hide navigation buttons
                lightboxPrev.style.display = currentImages.length > 1 ? 'flex' : 'none';
                lightboxNext.style.display = currentImages.length > 1 ? 'flex' : 'none';
            }
            
            // Close lightbox
            function closeLightbox() {
                lightbox.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // Navigation functions
            function prevImage() {
                if (currentImages.length <= 1) return;
                currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
                updateLightboxImage();
            }
            
            function nextImage() {
                if (currentImages.length <= 1) return;
                currentImageIndex = (currentImageIndex + 1) % currentImages.length;
                updateLightboxImage();
            }
            
            // Initialize lightbox
            initLightbox();
            
            // Add click listeners to all lightbox images
            lightboxImages.forEach((img, index) => {
                img.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent card expansion
                    openLightbox(index);
                });
            });
            
            // Close button
            lightboxClose.addEventListener('click', closeLightbox);
            
            // Background click to close
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            // Navigation buttons
            lightboxPrev.addEventListener('click', function(e) {
                e.stopPropagation();
                prevImage();
            });
            
            lightboxNext.addEventListener('click', function(e) {
                e.stopPropagation();
                nextImage();
            });
            
            // Touch/swipe support for mobile
            let touchStartX = 0;
            let touchEndX = 0;
            
            lightbox.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            lightbox.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50; // Minimum distance for a swipe
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0) {
                        // Swipe right - previous image
                        prevImage();
                    } else {
                        // Swipe left - next image
                        nextImage();
                    }
                }
            }
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (lightbox.classList.contains('active')) {
                    if (e.key === 'Escape') {
                        closeLightbox();
                    } else if (e.key === 'ArrowLeft') {
                        prevImage();
                    } else if (e.key === 'ArrowRight') {
                        nextImage();
                    }
                } else {
                    // Close other modals on escape
                    if (e.key === 'Escape') {
                        eventPreviews.forEach(c => c.classList.remove('expanded'));
                        document.getElementById('rsvp-modal').classList.remove('active');
                    }
                }
            });

            // RSVP functionality
            const rsvpModal = document.getElementById('rsvp-modal');
            const rsvpForm = document.getElementById('rsvp-form');
            const rsvpModalClose = document.getElementById('rsvp-modal-close');
            const rsvpCancel = document.getElementById('rsvp-cancel');
            const rsvpBtns = document.querySelectorAll('.rsvp-btn');
            let currentEventId = null;

            rsvpBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent card expansion
                    currentEventId = this.getAttribute('data-event-id');
                    const eventTitle = this.closest('.event-preview, .event-item').querySelector('h3').textContent;
                    document.getElementById('rsvp-event-title').textContent = `RSVP for ${eventTitle}`;
                    rsvpModal.classList.add('active');
                });
            });

            rsvpModalClose.addEventListener('click', function() {
                rsvpModal.classList.remove('active');
            });

            rsvpCancel.addEventListener('click', function() {
                rsvpModal.classList.remove('active');
            });

            rsvpModal.addEventListener('click', function(e) {
                if (e.target === rsvpModal) {
                    rsvpModal.classList.remove('active');
                }
            });

            rsvpForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!currentEventId) return;

                const formData = new FormData(this);
                formData.append('event_id', currentEventId);

                fetch(`/rsvp/${currentEventId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        rsvpModal.classList.remove('active');
                        
                        // Show congratulations overlay with parallax effects
                        const congratulationsOverlay = document.getElementById('congratulations-overlay');
                        const congratulationsDetails = document.getElementById('congratulations-details');
                        const eventTitle = document.querySelector(`[data-event-id="${currentEventId}"]`).closest('.event-preview, .event-item').querySelector('h3').textContent;
                        
                        congratulationsDetails.innerHTML = `
                            <div class="congratulations-icon">ðŸŽ‰</div>
                            <div class="congratulations-title">CONGRATULATIONS!</div>
                            <div class="congratulations-message">You're in for</div>
                            <div class="congratulations-event">${eventTitle}</div>
                            <div class="congratulations-count">${data.rsvp_count} RSVP${data.rsvp_count !== 1 ? 's' : ''} total</div>
                        `;
                        
                        congratulationsOverlay.classList.add('active');
                        
                        // Show toast notification
                        showToast(`Successfully RSVP'd for ${eventTitle}!`, 'success');
                        
                        // Auto-hide after 1.5 seconds (blink of an eye)
                        setTimeout(() => {
                            congratulationsOverlay.classList.remove('active');
                        }, 1500);
                        
                        // Update RSVP count display - only show when there are RSVPs
                        const rsvpBtn = document.querySelector(`[data-event-id="${currentEventId}"]`);
                        if (rsvpBtn) {
                            const rsvpSection = rsvpBtn.parentElement;
                        }
                        
                        // Reset form
                        this.reset();
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
            });
        });
        </script>
        
        {% block extra_js %}{% endblock %}
    </body>
</html>
